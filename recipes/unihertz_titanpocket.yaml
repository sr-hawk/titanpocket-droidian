architecture: arm64

actions:
  - action: debootstrap
    suite: bookworm
    components:
      - main
      - contrib
      - non-free
      - non-free-firmware
    mirror: http://deb.debian.org/debian

  - action: apt
    description: Install CA certs first (for HTTPS repos)
    packages:
      - ca-certificates


  - action: run
    description: Add local APT repo + Droidian production repo, then apt update
    chroot: true
    command: |
      set -e
      echo "deb [trusted=yes] https://raw.githubusercontent.com/sr-hawk/titanpocket-droidian/master/apt/ stable main" > /etc/apt/sources.list.d/_local-titanpocket.list
      echo "deb [trusted=yes] https://production.repo.droidian.org bookworm main"> /etc/apt/sources.list.d/_droidian.list
      apt-get update
      # Debug: show what apt sees
      apt-cache policy adaptation-hybris-api30-phone android-system-gsi-30-bin adaptation-unihertz-titanpocket || true

  - action: run
    description: Build and install ofono2mm from source
    chroot: true
    command: |
      set -e
      export DEBIAN_FRONTEND=noninteractive
      apt update
      apt install -y \
        git \
        build-essential \
        debhelper \
        dh-python \
        dpkg-dev \
        fakeroot \
        python3 \
        python3-dbus-next \
        python3-gi \
        python3-gi-cairo \
        gir1.2-glib-2.0 \
        gir1.2-gtk-3.0 \
        modemmanager \
        geoclue-2.0 \
        gir1.2-geoclue-2.0
      git clone https://github.com/droidian/oFono2MM.git /tmp/ofono2mm
      cd /tmp/ofono2mm
      if [ ! -f debian/changelog ]; then
        build_date="$(date -R)"
        printf '%s\n' \
          "ofono2mm (1.0-0local1) unstable; urgency=medium" \
          "" \
          "  * Auto-generated changelog for local build inside Droidian image build." \
          "" \
          " -- Droidian Builder <builder@local>  ${build_date}" \
          > debian/changelog
      fi
      dpkg-buildpackage -us -uc -b
      cd /tmp
      apt install -y ./ofono2mm_*_all.deb


  - action: apt
    description: Install Halium base + Android GSI + your adaptation
    packages:
      - adaptation-hybris-api30-phone
      - android-system-gsi-30-bin
      - adaptation-unihertz-titanpocket

  - action: run
    description: Clean apt cache
    chroot: true
    command: apt-get clean

  - action: filesystem-deploy
    description: Create rootfs tarball
    image: droidian-rootfs-phosh-api30-arm64.tar.xz
    compression: xz

  - action: image-partition
    description: Build system.img
    imagename: system.img
    imagesize: 3500M
    partitiontype: gpt
    partitions:
      - name: system
        fs: ext4
        start: 0%
        end: 100%
        content:
          - source: rootfs
            type: directory
